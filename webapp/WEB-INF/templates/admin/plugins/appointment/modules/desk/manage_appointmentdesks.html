<#include "manageappointmentdesk_tabs.html" />
<#-- TODO Add id_form value to model -->

<script src="js/plugins/appointment/selectable.js"></script>
<script src="js/plugins/appointment/selectable.table.min.js"></script>

<script src="js/plugins/appointment/moment.min.js"></script>
<script src="js/plugins/appointment/bootstrap-datetimepicker.min.js"></script>

<script src="js/bootstrap-datepicker.js"></script>
<script src="js/locales/bootstrap-datepicker.<@getRegional language=language />.js" charset="utf-8"></script>

<link rel="stylesheet" href="js/plugins/appointment/fullcalendar.min.css" >
<link rel="stylesheet" href="css/admin/plugins/appointment/fullcalendar.custom.css" >
<link rel="stylesheet" href="css/admin/plugins/appointment/appointment_desk.css"/>
<link rel='stylesheet' href='css/plugins/appointment/bootstrap-datetimepicker.css' />
<@row>
	<@columns>
	<@messages infos=infos errors=errors />
		<!#-- FIXME USE MACRO  @ appointmentTabs tab="specificDay" appointmentform=appointmentform  -->
		<@tabs params=' style="margin-top:1rem;"'>
			<@tabList>
				<@tabLink href='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek&id_form=${idForm!}' title='#i18n{appointment.typicalWeek.pageTitle}' />
				<@tabLink href='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageSpecificWeek&id_form=${idForm!}' title='#i18n{appointment.specificWeek.pageTitle}' />
				<@tabLink active=true href='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp?plugin_name=appointment-desk&id_form=${idForm!}' title='#i18n{appointment.specificDay.pageTitle}' />
			</@tabList>
			<@tabContent>
			<@messages infos=infos />
			<div id="calendar" class="fc ui-widget fc-ltr">
				<div class="fc-toolbar fc-header-toolbar row">
					<div class="fc-left">
						<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' >
							<#assign dDay = day?date>
							<#assign pDay = dDay?long - (1 * 24 * 60 * 60 * 1000)>
							<@input type='hidden' name='id_form' value='${idForm!1}' />
							<@input type='hidden' name='day' value='${pDay?number_to_date}' />
							<button type="submit" class="btn btn-primary btn-sm">
								#i18n{module.appointment.desk.label.prevDay}
							</button>
						</@tform>
					</div>
					<div class="fc-right">
						<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' class='hidden-xs'>
						<#assign nDay = dDay?long + (1 * 24 * 60 * 60 * 1000)>
						<@input type='hidden' name='id_form' value='${idForm!1}' />
						<@input type='hidden' name='day' value='${nDay?number_to_date}' />
						<button type="submit" class="btn btn-primary btn-sm">
							#i18n{module.appointment.desk.label.nextDay}
						</button>
						</@tform>
					</div>
					<div class="fc-center">
						<#if day?date?string != .now?date?string >
							<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' >
								<#assign dDay = .now>
								<@input type='hidden' name='id_form' value='${idForm!1}' />
								<@input type='hidden' name='day' value='${dDay?date}' />
								<button type="submit" class="btn btn-primary btn-sm">
									#i18n{module.appointment.desk.label.today}
								</button>
							</@tform>
						</#if>
						<@tform type='inline' id='manage_appointmentdesk' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp'>
							<input type="hidden" name="id_form" value="${idForm!1}">
							<button type="button" class="fc-datepicker btn btn-primary btn-sm">
								Choisir une date
							</button>
							<@input type='text' name='day' id='day' value="${day!''}" params=' style="border:none;font-family: \'Source Sans Pro\',sans-serif;font-size:30px"' />
						</@tform>
					</div>
				</div>
				<div class="fc-clear"></div>
				<div class="fc-view-container">
					<div class="fc-view fc-agendaWeek-view fc-agenda-view">
					<@table id='selectable' class="clearfix" >
					<tr>
						<th>
							<@button type='button' color='link' style='btn-link' class='open-desk' params=' data-toggle="modal"' buttonTargetId='#deskModal' title='#i18n{appointmentdesk.manage_appointmentdesks.label.addDesk}' hideTitle=['all'] buttonNested=true >
								<@iconStack class='fa-1x'>
									<@icon style='desktop' class='fa-stack-2x' />
									<@icon style='plus' class='fa-stack-1x' />
								</@iconStack>
							</@button>
						</th>
						<#assign x=numb_desk>
						<#list 1..x as seq >
							<th>#i18n{module.appointment.desk.label.desk} #i18n{module.appointment.desk.label.deskNo}${seq}</th>
						</#list>
						<th class="bg-danger">#i18n{module.appointment.desk.label.surbooking}</th>
					</tr>
					<@tableHeadBodySeparator />
					<tr>
						<td>
							<@button id='toggle-add-comment' style='none' class='btn btn-link' title='#i18n{module.appointment.desk.label.addComment}' hideTitle=['all'] params=' data-toggle="modal" data-target="#commentModal" ' buttonNested=true>
								<@iconStack class='fa-sm'>
									<@icon style='comment-o' class='fa-stack-2x' />
									<@icon style='plus' class='fa-stack-1x' />
								</@iconStack>
							</@button>								
						</td>
						<td colspan="${x}" class="">
						<#if list_comments?size gt 0>
							<#list list_comments as comment>
							<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
							<#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
							<span class="fc-event comments">
								<div class="fc-content " id="comment_${comment.id}">
									<span class="fc-title">
										${comment_title}
									</span>
								</div>
							</span>
							</#if>
							</#list>
							
						</#if>
						</td>
						<td class="bg-danger"></td>
					</tr>
					<#list list_slot as slot>
						<tr>
							<td data-selectable="row">${slot.startingTime!}
							<#if list_comments?size gt 0>
                            <#list list_comments as comment>
                            <#if comment.startingValidityTime?? || comment.endingValidityTime??>
                            <#assign startLabel>${comment.startingValidityTime!'${list_slot[0].startingTime!}'}</#assign>
                            <#assign endLabel>${comment.endingValidityTime!'${list_slot[list_slot?size - 1].endingTime!}'}</#assign>
                            <#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
                            <#if startLabel?split(':')[0] == slot.startingTime?split(':')[0]>
                            <span class="fc-event comments timed-comment" style="height: calc(( ${endLabel?split(':')[0]} - ${startLabel?split(':')[0]} ) * 100%);">
                                <div class="fc-content hover-content timed-comment-content" id="comment_${comment.id}" >
                                </div>
                            </span>
                            </#if>
                            </#if>
                            </#list>
                            </#if>
							</td>	
							<#list 1..x as seq >
								<td id="slot-${slot.idSlot!}-desk${seq}" class="place selectable <#if slot.isOpen && ( seq-slot.maxCapacity lte 0) >slot-open<#else>slot-close</#if>" data-slot="{'idSlot':'${slot.idSlot!}','startingDateTime':'${slot.startingDateTime}','endingDateTime':'${slot.endingDateTime}','maxCapacity':'${slot.maxCapacity}','isOpen':'<#if slot.isOpen && seq lte slot.maxCapacity >true<#else>false</#if>','isSpecific':'${slot.isSpecific?c}','idForm':'${slot.idForm!1}'}" ></td>	
							</#list>
							<td id="slot-${slot.idSlot!}-desk${x+1!}" class="bg-danger is-surbook" data-slot="" >
						</tr>
					</#list>
					</@table>
			</@tabContent>
		</@tabs>
		<hr>
    </@columns>
</@row>

<@modal id='qModal'>
	<@modalBody>
		<p id="loader" class="text-center">
			<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw"></i>
			<span class="sr-only">#i18n{blog.modify_blog.labelLoading}</span>
		</p>
		<iframe style="width:100%;height:60vh;border:0" frameborder="0" id="qModalFrame" src=""></iframe>
	</@modalBody>
</@modal>

<@modal id='slottoggle'>
	<@modalBody>
		<@radioButton id='doOpenSlot' name='doManageSlot' value='1' labelKey='#i18n{module.appointment.desk.label.open}' /> 
		<@radioButton id='doCloseSlot' name='doManageSlot'  value='0' labelKey='#i18n{module.appointment.desk.label.close}' /> 
		<@button id='saveSlotState' color='primary' title='#i18n{module.appointment.desk.label.save}' />
		<@button id='cancelSlotState' color='secondary' title='#i18n{module.appointment.desk.label.cancel}' params=' data-dismiss="modal" aria-label="#i18n{module.appointment.desk.label.cancel}"' />
	</@modalBody>
</@modal>

<@modal id='deskModal'>
	<@modalHeader modalTitle='#i18n{module.appointment.desk.increment.defaultTitle}' />
	<@modalBody>
		<p id="loader" class="text-center">#i18n{module.appointment.desk.increment.defaultTitle}</p>
		<@tform id='form-validate' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='action' value='incrementMaxCapacity' />
			<@input type='hidden' name='id_form' value='${idForm!}' />
			<@formGroup labelFor='incrementing_value' labelKey='#i18n{module.appointment.desk.increment.labelIncrementingValue}' helpKey='${formGroupHelpKey!}' mandatory=true>
					<@input type='number' name='incrementing_value' id='incrementing_value' value='1' maxlength=2 params='onkeypress="return validateQty(event);"' min=1 max=10 />
			</@formGroup>
			<@formGroup labelFor='type' labelKey='#i18n{module.appointment.desk.increment.labelType}'>
				<@select name='type' id='type' items=list_types default_value='' />
			</@formGroup>
			<@formGroup labelFor='startingDate' labelKey='#i18n{module.appointment.desk.increment.labelStartingDate}'>
				<@inputGroup>
					<@input type='text' name='starting_date' id='startingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='startingTime' labelKey='#i18n{module.appointment.desk.increment.labelStartingTime}'>
				<@inputGroup>
					<@input type='text' name='starting_time' id='startingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingDate' labelKey='#i18n{module.appointment.desk.increment.labelEndingDate}'>
				<@inputGroup>
					<@input type='text' name='ending_date' id='endingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingTime' labelKey='#i18n{module.appointment.desk.increment.labelEndingTime}'>
				<@inputGroup>
					<@input type='text' name='ending_time' id='endingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup>
				<@button type='submit' name='save' id='save' buttonIcon='check' title='#i18n{module.appointment.desk.increment.labelValidate}' />
			</@formGroup>	
		</@tform>
	</@modalBody>
</@modal>

<@modal id='commentModal'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "startingValidityDate" "endingValidityDate" "idStartingTime" "idEndingTime" "doAddComment" idForm min_time!0 max_time!23 language />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "modifyStartingValidityDate" "modifyEndingValidityDate" "idModifyStartingTime" "idModifyEndingTime" "doModifyComment" idForm min_time!0 max_time!23 language />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<script>
if( $('.selectable').length > 0 ){
	const table = document.querySelector("table");
	const selectable = new Selectable({
		appendTo: table,
		filter: table.querySelectorAll(".selectable"),
		toggle: true,
		saveState: 10,
		lasso: {
			border: "4px dotted rgba( 0, 248, 41, 1)",
			borderRadius: "0",
			backgroundColor: "rgba(0, 248, 41, 0.5)"
		}       
	});

	selectable.table();

	selectable.on( "end", function(e, selected, unselected) {
		var slotData='', idx=1;
		var a=selectable.getSelectedNodes();
		var slotSize = a.length;
		if ( slotSize > 0 ){
			a.forEach( function( el ){
				var sClass = el.classList.contains('is-multi');
				var sItems = '.' + el.dataset.multi;
				var items = document.querySelectorAll( sItems );
				selectable.select(items);
			});
			b=selectable.getSelectedNodes();
			var slotSize = b.length;
			b.forEach( function( el ){
				slotData = slotData + el.dataset.slot;
				if( idx < slotSize ) slotData = slotData + ','
				idx++; 
			});
			slotData = '[' +  slotData.replace(/\'/ig,'"') + ']';
			// Show Modal
			$('#slottoggle').modal('toggle');
			$('#slottoggle').on('shown.bs.modal', function (event) {
				var modal = $(this), btnModal = modal.find('#saveSlotState'), action='', jspUrl = 'jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp?action=', filteredSlotData=null; 
				btnModal.click( function( e ){
					var isOpen = modal.find('.modal-body input:checked').val();
					var JData = JSON.parse( slotData );
					/* Ajax 		*/	
					if( isOpen==0 ){
						action = 'closeAppointmentDesk';
						filteredSlotData = JData.filter( function (slot) {
							return slot.isOpen === 'true';
						});
					} else {
						action = 'openAppointmentDesk';
						filteredSlotData = JData.filter( function (slot) {
							return slot.isOpen === 'false';
						});
					}
					var newData =  JSON.stringify( filteredSlotData );
					if( filteredSlotData.length > 0 ){
						$.ajax({
							url: jspUrl + action,
							dataType: 'json',
							type: 'POST',
							cache: false,
							data:{'data': newData},
							success: function( data, textStatus, jQxhr ){
								$('#manage_appointmentdesk').submit();
							},
							error: function( jqXhr, textStatus, errorThrown ){
								$('#manage_appointmentdesk').submit();
							},
							xhrFields: {
								withCredentials: true
							},
							crossDomain: true
						});
					} else {
						$('#slottoggle').modal('hide');
					}
				});
			});
			$('#slottoggle').on('hidden.bs.modal', function (event) {
				selectable.clear()
			});
		}
	});
}
	
$(function () {
	/* Add Form title */
	// FIXME : Add form.title to model
	$('.content-header h1').html("<a href=\"jsp/admin/plugins/appointment/ManageAppointmentForms.jsp\" title=\"#i18n{appointment.adminFeature.ManageAppointmentForm.name}\">#i18n{appointment.adminFeature.ManageAppointmentForm.name} <small>${appointmentForm.title!}</small></a>");
	$('.bt-slot > .fa').toggle();
	
	$('#day').datepicker({
		language : '${language}',
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	}).on( 'changeDate', function(e) {
		// `e` here contains the extra attributes
		$('#manage_appointmentdesk').submit();
	});

	$('.fc-datepicker').click( function(){
		$('#day').datepicker('show');
	});

	$('#qModal').on('shown.bs.modal', function () {
		$('#qModalFrame').attr("src", urlPublished );
		$('#qModalFrame').load( function () {
		$('#qModalFrame').show();
		$('#loader').hide();
		});
	});
	
	// DESK ADD MODAL
	$('#startingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});

	$('#endingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});

	$('#startingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	});
	$('#endingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	});  
	
	<#if list_comments?size gt 0>
		<#list list_comments as comment>
			<#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
			<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
			$('#comment_${comment.id} p').prepend( '[ ${comment.creatorUserName!} | ${comment.creationDate?date.xs!} ] ').append( '<div class="btn-comments"><a href="" class="toggle-modify-comment" data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}" }\' ><i class="fa fa-pencil fa-fw"></i></a><a href="jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=${comment.id}" class="closeon text-danger"><i class="fa fa-remove fa-fw"></i></a></div>');
			var json = {
				"container": "body",
				"placement" : "bottom",
				"html" : true,
				"trigger" : "hover"
			};
			<#else>
	        $('#comment_${comment.id}').append( '<div class="btn-comments"><span data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}", \"comment_creator\":\"${comment.creatorUserName!}", \"comment_creation_date\":\"${comment.creationDate!}" }\' ><i class="fa fa-pencil fa-fw"></i></span></div>');
	        var json = {
	                "container": "body",
	                "placement" : "right",
	                "html" : true,
	                "trigger" : "click"
	            };
	        </#if>
			if ( '${comment.endingValidityDate}' == null || '${comment.endingValidityDate}' == undefined ){
				labelEventDate='Le ' + '${comment.startingValidityDate?date.xs}';
			} else {
				moment.locale("${locale}");
				labelEventDate = 'Du ' + '${comment.startingValidityDate?date.xs} ${comment.startingValidityTime!}'+ ' au '+ '${comment.endingValidityDate?date.xs} ${comment.endingValidityTime!}';
				
			}
			
			<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
			json.content = '<p>' + labelEventDate +'</p><hr>${comment_title}<hr><p><strong>Par ${comment.creatorUserName!}</strong> le <time>${comment.creationDate!}</time></p>';
			$('#comment_${comment.id} p').popover( json );
			<#else>
			$("#comment_${comment.id}").click( function ( event ) {
				json.content = '<p>' + labelEventDate +'</p><hr>${comment_title}<hr><p><strong>Par ${comment.creatorUserName!}</strong> le <time>${comment.creationDate!}</time></p><a class="toggle-modify-comment" data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}", \"comment_creator\":\"${comment.creatorUserName!}", \"comment_creation_date\":\"${comment.creationDate!}" }\' ><i class="fa fa-pencil fa-fw"></i></a><a href="jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=${comment.id}" class="closeon text-danger"><i class="fa fa-remove fa-fw"></i></a>';
			   $("div[id*=comment_]").not($("#comment_${comment.id}")).each(function(index, element){
				   if( isOver( $(this), event ) ) {
					    json.content += "<p>Du " + new Date(jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_start).toLocaleDateString("${language}") + " " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_start_time + " au " + new Date(jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_end).toLocaleDateString("${language}") + " " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_end_time + "</p>";
					    json.content += "<hr>" + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_text;
					    json.content += "<hr><p><strong>Par " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_creator + "</strong> le " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_creation_date + "</p>";
				    
				   }
				      
			    });
			   
 			   $("#comment_${comment.id}").attr("data-content", json.content);
 			   $("#comment_${comment.id}").popover( json );
			   
			});
			</#if>
			 

		</#list>
	</#if>
	var modComment = $('table').find('.toggle-modify-comment');
	$(modComment).click( function(ev) {
		ev.preventDefault();
		var formValues = JSON.parse( $(this).attr( "data-json" ) );
		$("#modify-comment input[name='id_comment']").val( formValues.id_comment );
		tinyMCE.activeEditor.setContent( formValues.comment_text );
		$( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_start ) );
		$( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_end ) );
        $( "#modify-comment input[name='startingValidityTime']" ).val( formValues.comment_start_time );
        $( "#modify-comment input[name='endingValidityTime']" ).val( formValues.comment_end_time );
		$( "#modify-comment" ).modal('show');
	});
});  
  
var strSlots='<#list list_appointment as app><#list app.slot as slotApp>${slotApp.idSlot},</#list></#list>';
strSlots = strSlots.slice(0, -1);
var aSlots = strSlots.split(',');

const countOccurrences = (aSlots) => {
    const map = {};
    for ( var i = 0; i < aSlots.length; i++ ) {
        map[aSlots[i]] = ~~map[aSlots[i]] + 1;
    }
    return map;
}
var nSurbook=${numb_desk}+1;
<#assign currSlot=0>
<#list list_appointment as app>
	<#list app.slot?sort_by('startingDateTime') as slotApp>
		<#if currSlot!=slotApp.idSlot>
			<#assign currSlot=slotApp.idSlot>	
			var pos=1;
		<#else>
			pos++;
		</#if>
		
		var slot=$('#slot-${slotApp.idSlot}-desk' + pos );
		if ( slot.hasClass('is-occupied') ){
			pos++;
			slot=$('#slot-${slotApp.idSlot}-desk' + pos );
		}
		slot.attr('data-multi','multi-${app.idAppointment}');
		slot.attr('data-rdv','rdv${app.idAppointment}_slot${slotApp.idSlot!}');
		if( slot.hasClass('slot-open') ){
			slot.addClass('is-occupied');
			<#if app.slot?size gt 1>slot.addClass('is-multi multi-${app.idAppointment}');</#if>
			slot.append('<span> ${app.user.lastName} ${app.user.firstName} <#if app.nbPlaces gt 1>( nb pers. ${app.nbPlaces} )</#if> </span>');
		} else {
			slot.addClass('is-occupied');
			<#if app.slot?size gt 1>slot.addClass('is-multi multi-${app.idAppointment}');</#if>
			var surbookSlot=$('#slot-${slotApp.idSlot}-desk' + nSurbook );
			<#if app.slot?size gt 1>surbookSlot.addClass('is-surbook-${app.idAppointment}' );</#if>
			surbookSlot.attr('data-rdv','rdv${app.idAppointment}_slot${slotApp.idSlot!}');
			surbookSlot.append('<span class="surbook"> ${app.user.lastName} ${app.user.firstName} <#if app.nbPlaces gt 1>( nb pers. ${app.nbPlaces} )</#if> </span>');
		} 
	</#list>
</#list>

<#list list_appointment as app>
	<#if app.slot?size gt 1>
		<#assign idx=1>
		<#list app.slot?sort_by('startingDateTime') as appSlot>
			var hasSurbookSlot=$('.is-surbook-${app.idAppointment}' ).length;
			console.log( '${app.idAppointment} slot${appSlot.idSlot!}  ${appSlot.startingDateTime} ${app.slot?size} has mulit : ' + hasSurbookSlot );
			<#if idx = 1>
				var hSize = 42 * ${app.slot?size}  + 'px';
				$('.multi-${app.idAppointment}:first > span').css('height', hSize );
				$('.is-surbook-${app.idAppointment} > .surbook').css('background-color', '#f8000c' ).css('color', '#f8000c' ).css('height', hSize );
				$('.is-surbook-${app.idAppointment}:first > .surbook').css('color', '#fff' );
				<#assign idx++>
			<#else>
				$('.multi-${app.idAppointment} > span').css('color','#6d015b');
				$('.multi-${app.idAppointment}:first > span').css('color','#fff');
			</#if>
		</#list>
	</#if>
</#list>

function isOver( element, e ) {
	let elementCalculated = element;
    var left = elementCalculated.offset().left,
        top = elementCalculated.offset().top,
        right = left + element.width(),
        bottom = top + element.height();
    console.log("souris = " + e.pageX + ", gauche = " + left +", souris hz = " + e.pageX +", droite = " + right + ", souris vertical = " + e.pageY + ", haut= " + top + ", souris vertical = " + e.pageY + ", bas = " + bottom);
        
    if ( e.pageX > left && e.pageX < right && e.pageY > top && e.pageY < bottom ){
    	return true;
    }else{
    	return false;
    }
    
}
</script>
<#include "/admin/util/editor/editor.html" />
<@initEditor type='comment' />
